<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owner Auth - Web App</title>
    <!-- React és Babel betöltése a böngészőben való futtatáshoz -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS a stílusokhoz -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Ikonok -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: black; color: #d4d4d8; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        /* Ikonok alapértelmezett megjelenítése */
        i[data-lucide] { display: inline-block; vertical-align: middle; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- KONFIGURÁCIÓ ---
        // Itt add meg a futó server.js címet!
        const API_BASE = 'http://localhost:5000/api'; 

        const App = () => {
            const [token, setToken] = useState(localStorage.getItem('owner_token'));
            const [view, setView] = useState('loading');
            const [shareToken, setShareToken] = useState(null);
            
            // Admin állapotok
            const [password, setPassword] = useState('');
            const [keys, setKeys] = useState([]);
            const [shares, setShares] = useState([]);
            const [loading, setLoading] = useState(false);
            const [isAdding, setIsAdding] = useState(false);
            const [newName, setNewName] = useState('');
            const [newSecret, setNewSecret] = useState('');
            const [isSharing, setIsSharing] = useState(null);
            const [shareLabel, setShareLabel] = useState('');

            // Vendég állapotok
            const [guestPassword, setGuestPassword] = useState('');
            const [guestData, setGuestData] = useState(null);
            const [guestError, setGuestError] = useState('');

            // URL paraméterek ellenőrzése (megosztott link-e?)
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const sToken = params.get('share');
                if (sToken) {
                    setShareToken(sToken);
                    setView('guest');
                } else {
                    setView(token ? 'admin' : 'login');
                }
            }, [token]);

            // Ikonok újrainicializálása renderelés után
            useEffect(() => {
                if (view !== 'loading') {
                    const timer = setTimeout(() => {
                        if (window.lucide) window.lucide.createIcons();
                    }, 50);
                    return () => clearTimeout(timer);
                }
            }, [view, keys, shares, isAdding, isSharing, guestData]);

            const refreshAdminData = async () => {
                if (!token || view !== 'admin') return;
                try {
                    const h = { 'Authorization': token };
                    const [kRes, sRes] = await Promise.all([
                        fetch(`${API_BASE}/keys`, { headers: h }),
                        fetch(`${API_BASE}/shares`, { headers: h })
                    ]);
                    if (kRes.ok) setKeys(await kRes.json());
                    if (sRes.ok) setShares(await sRes.json());
                } catch (e) { console.error("Adatlekérési hiba a szervertől."); }
            };

            useEffect(() => {
                if (view === 'admin') {
                    refreshAdminData();
                    const interval = setInterval(refreshAdminData, 10000);
                    return () => clearInterval(interval);
                }
            }, [view, token]);

            // Admin bejelentkezés
            const handleLogin = async () => {
                setLoading(true);
                try {
                    const res = await fetch(`${API_BASE}/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        setToken(data.token);
                        localStorage.setItem('owner_token', data.token);
                        setView('admin');
                    } else { alert(data.error); }
                } catch (e) { alert("A szerver nem érhető el!"); }
                setLoading(false);
            };

            // Új kulcs hozzáadása
            const addKey = async () => {
                if (!newName || !newSecret) return;
                await fetch(`${API_BASE}/keys`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify({ name: newName, secret: newSecret })
                });
                setNewName(''); setNewSecret(''); setIsAdding(false);
                refreshAdminData();
            };

            // Kulcs törlése
            const deleteKey = async (id) => {
                if (!confirm("Biztosan törölni szeretnéd ezt a kulcsot?")) return;
                await fetch(`${API_BASE}/keys/${id}`, { method: 'DELETE', headers: { 'Authorization': token } });
                refreshAdminData();
            };

            // Megosztási link létrehozása
            const createShare = async (keyId) => {
                const res = await fetch(`${API_BASE}/shares`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify({ keyId, label: shareLabel })
                });
                const data = await res.json();
                const shareLink = `${window.location.origin}${window.location.pathname}?share=${data.shareToken}`;
                prompt("Másold ki a hozzáférési adatokat:", `Link: ${shareLink} | Jelszó: ${data.password}`);
                setShareLabel(''); setIsSharing(null);
                refreshAdminData();
            };

            // Megosztás visszavonása
            const revokeShare = async (id) => {
                if (!confirm("Biztosan vissza akarod vonni ezt a meghívót?")) return;
                await fetch(`${API_BASE}/shares/${id}`, { method: 'DELETE', headers: { 'Authorization': token } });
                refreshAdminData();
            };

            // Vendég kód feloldása
            const unlockShare = async () => {
                setLoading(true);
                try {
                    const res = await fetch(`${API_BASE}/public/code`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token: shareToken, password: guestPassword })
                    });
                    const data = await res.json();
                    if (res.ok) { setGuestData(data); setGuestError(''); }
                    else { setGuestError(data.error); }
                } catch (e) { setGuestError("Szerver hiba történt."); }
                setLoading(false);
            };

            // Biztonságos ikonmegjelenítő
            const Icon = ({ name, size = 24, className = "" }) => (
                <span className={`inline-flex items-center justify-center ${className}`}
                      style={{ width: size, height: size }}
                      dangerouslySetInnerHTML={{ __html: `<i data-lucide="${name}" style="width: ${size}px; height: ${size}px"></i>` }} />
            );

            if (view === 'loading') return <div className="min-h-screen flex items-center justify-center font-bold">Betöltés...</div>;

            // BEJELENTKEZŐ NÉZET
            if (view === 'login') return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="w-full max-w-sm bg-zinc-900 border border-zinc-800 p-8 rounded-[2.5rem] shadow-2xl text-center">
                        <Icon name="lock" className="text-blue-500 mx-auto mb-6" size={40} />
                        <h1 className="text-white text-2xl font-bold mb-8">Tulajdonos Belépés</h1>
                        <input type="password" placeholder="Mesterjelszó" className="w-full bg-zinc-800 border-none rounded-2xl p-4 text-white mb-4 outline-none focus:ring-2 focus:ring-blue-500" value={password} onChange={e => setPassword(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleLogin()} />
                        <button onClick={handleLogin} className="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl hover:bg-blue-700 transition-all">Belépés</button>
                    </div>
                </div>
            );

            // VENDÉG NÉZET
            if (view === 'guest') return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="w-full max-w-md bg-zinc-900 border border-zinc-800 p-10 rounded-[2.5rem] shadow-2xl text-center">
                        {!guestData ? (
                            <>
                                <Icon name="users" className="text-blue-500 mx-auto mb-6" size={40} />
                                <h1 className="text-white text-xl font-bold mb-6">Kód feloldása</h1>
                                {guestError && <div className="text-red-500 text-xs mb-4">{guestError}</div>}
                                <input type="password" placeholder="Megosztási jelszó" className="w-full bg-zinc-800 border-none rounded-xl p-4 text-white mb-4 outline-none" value={guestPassword} onChange={e => setGuestPassword(e.target.value)} />
                                <button onClick={unlockShare} className="w-full bg-white text-black font-bold py-4 rounded-xl">Megtekintés</button>
                            </>
                        ) : (
                            <div>
                                <span className="text-blue-500 text-xs font-bold uppercase tracking-widest">{guestData.name}</span>
                                <div className="text-6xl font-black text-white mt-6 mb-8 tracking-wider italic mono">
                                    {guestData.code.slice(0,3)} {guestData.code.slice(3)}
                                </div>
                                <div className="text-zinc-500 text-sm flex items-center justify-center gap-2">
                                    <Icon name="refresh-cw" size={14} className="animate-spin" /> Frissül: {guestData.remaining} mp
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );

            // ADMIN PANEL NÉZET
            return (
                <div className="min-h-screen p-4 md:p-10">
                    <div className="max-w-6xl mx-auto">
                        <header className="flex justify-between items-center mb-12">
                            <div className="flex items-center gap-3">
                                <div className="bg-blue-600 p-2 rounded-xl text-white flex items-center justify-center"><Icon name="shield" size={24} /></div>
                                <h1 className="text-white font-black text-xl">OWNER AUTH</h1>
                            </div>
                            <button onClick={() => { setToken(null); localStorage.removeItem('owner_token'); }} className="text-zinc-600 hover:text-white transition-colors">
                                <Icon name="log-out" size={24} />
                            </button>
                        </header>

                        <div className="grid lg:grid-cols-3 gap-10">
                            <div className="lg:col-span-2 space-y-6">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-2xl font-bold text-white">Saját Kulcsok</h2>
                                    <button onClick={() => setIsAdding(true)} className="bg-white text-black px-5 py-2 rounded-xl font-bold text-sm">Új Kulcs</button>
                                </div>
                                {isAdding && (
                                    <div className="bg-zinc-900 p-6 rounded-3xl border border-zinc-800 space-y-4">
                                        <div className="grid md:grid-cols-2 gap-4">
                                            <input type="text" placeholder="Szolgáltatás neve" className="bg-zinc-800 p-4 rounded-xl outline-none text-white" value={newName} onChange={e => setNewName(e.target.value)} />
                                            <input type="text" placeholder="Secret Key (Base32)" className="bg-zinc-800 p-4 rounded-xl outline-none text-white" value={newSecret} onChange={e => setNewSecret(e.target.value)} />
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={addKey} className="flex-1 bg-blue-600 py-3 rounded-xl font-bold text-white">Kulcs Mentése</button>
                                            <button onClick={() => setIsAdding(false)} className="flex-1 bg-zinc-800 py-3 rounded-xl text-white font-bold">Mégse</button>
                                        </div>
                                    </div>
                                )}
                                <div className="grid gap-4">
                                    {keys.map(k => (
                                        <div key={k.id} className="bg-zinc-900/50 p-8 rounded-[2rem] border border-zinc-800 flex justify-between items-center group transition-all">
                                            <div>
                                                <span className="text-blue-500 text-xs font-bold uppercase tracking-widest">{k.name}</span>
                                                <div className="text-5xl font-black text-white mt-2 tracking-widest mono">{k.code.slice(0,3)} {k.code.slice(3)}</div>
                                            </div>
                                            <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <button onClick={() => setIsSharing(k.id)} className="p-4 bg-zinc-800 rounded-2xl hover:text-blue-400" title="Megosztás"><Icon name="share-2" size={24} /></button>
                                                <button onClick={() => deleteKey(k.id)} className="p-4 bg-zinc-800 rounded-2xl hover:text-red-500" title="Törlés"><Icon name="trash-2" size={24} /></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div className="space-y-6">
                                <h3 className="text-lg font-bold text-white flex items-center gap-2"><Icon name="users" size={20} /> Aktív Meghívók</h3>
                                <div className="space-y-3">
                                    {shares.map(s => (
                                        <div key={s._id} className="p-5 bg-zinc-900 rounded-3xl border border-zinc-800">
                                            <div className="flex justify-between mb-2">
                                                <span className="text-white font-bold">{s.label}</span>
                                                <button onClick={() => revokeShare(s._id)} className="text-zinc-600 hover:text-red-500"><Icon name="x-circle" size={18} /></button>
                                            </div>
                                            <div className="text-[10px] uppercase font-bold text-zinc-600 mb-4 tracking-tighter">Hozzárendelve: {s.keyId?.name}</div>
                                            <button onClick={() => {
                                                const link = `${window.location.origin}${window.location.pathname}?share=${s.shareToken}`;
                                                navigator.clipboard.writeText(link); alert("Link a vágólapra másolva!");
                                            }} className="w-full py-2 bg-zinc-800 rounded-xl text-[10px] font-bold text-blue-400">LINK MÁSOLÁSA</button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                    {isSharing && (
                        <div className="fixed inset-0 bg-black/90 flex items-center justify-center p-4 z-50">
                            <div className="bg-zinc-900 p-10 rounded-[3rem] max-w-sm w-full border border-zinc-800 text-center">
                                <h3 className="text-xl font-bold text-white mb-6">Új megosztás</h3>
                                <input type="text" placeholder="Kinek szánod?" className="w-full bg-zinc-800 p-4 rounded-2xl mb-6 outline-none text-white border border-transparent focus:border-blue-500" value={shareLabel} onChange={e => setShareLabel(e.target.value)} />
                                <div className="flex gap-3">
                                    <button onClick={() => createShare(isSharing)} className="flex-1 bg-blue-600 py-4 rounded-2xl font-bold text-white">Létrehozás</button>
                                    <button onClick={() => setIsSharing(null)} className="flex-1 bg-zinc-800 py-4 rounded-2xl text-white font-bold">Mégse</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
